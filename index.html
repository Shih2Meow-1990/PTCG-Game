<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PTCG ÂæóÂç°ÊåëÊà∞ | Êï∏ÊìöÁµÇÁ´Ø v4.8</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=JetBrains+Mono:wght@700;900&display=swap');
        
        :root {
            --pk-yellow: #facc15;
            --pk-brown: #78350f;
            --pk-bg: #fffbeb; 
        }

        body, html {
            height: 100%;
            margin: 0;
            background-color: var(--pk-bg); 
            color: var(--pk-brown);
            font-family: 'Inter', sans-serif;
            overflow: hidden; 
            -webkit-font-smoothing: antialiased;
        }

        /* Áü©Èô£Ê†∏ÂøÉÔºöÁ∏±ÂêëÊí≤Êªø */
        .matrix-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            gap: 0.35rem;
        }

        .matrix-grid-row {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 0.35rem;
            flex: 1;
        }

        .matrix-cell { 
            background: white; 
            border: 2px solid rgba(120, 53, 15, 0.08); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            border-radius: 12px;
            color: var(--pk-brown);
            font-weight: 900;
            transition: all 0.2s cubic-bezier(0.16, 1, 0.3, 1);
            font-size: clamp(1.1rem, 2.8vh, 1.5rem); 
            height: 100%;
            box-shadow: 0 1px 3px rgba(0,0,0,0.02);
        }

        /* Â∞ç‰ΩçÊñπÂ°ä */
        .mapping-node { 
            width: 38px; 
            height: 46px; 
            background: white; 
            border: 2px solid rgba(120, 53, 15, 0.15); 
            border-radius: 8px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            cursor: pointer; 
            transition: all 0.15s;
            user-select: none;
            font-size: 0.95rem; 
            font-weight: 700;
            color: var(--pk-brown);
        }

        .mapping-node.selected { 
            border-color: var(--pk-brown); 
            background: var(--pk-yellow); 
            color: var(--pk-brown);
            box-shadow: 0 4px 10px rgba(250, 204, 21, 0.35); 
            transform: scale(1.08);
        }

        .mapping-node.used {
            background: #f1f5f9;
            color: #cbd5e1;
            border-color: #e2e8f0;
            opacity: 0.4;
            pointer-events: none; 
            box-shadow: none;
        }

        /* Ê®ôÁ±§Ê®£Âºè */
        .tab-btn { 
            padding: 5px 12px; 
            font-size: 10px; 
            font-weight: 900;
            text-transform: uppercase; 
            border-radius: 6px 6px 0 0;
            transition: all 0.2s; 
            color: var(--pk-brown);
            background: rgba(120, 53, 15, 0.04);
            border: 1.5px solid rgba(120, 53, 15, 0.1);
            border-bottom: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            white-space: nowrap;
        }
        .tab-btn.active { color: white; background: var(--pk-brown); border-color: var(--pk-brown); }
        
        .delete-x {
            width: 13px; height: 13px;
            background: rgba(255,255,255,0.15);
            border-radius: 50%; font-size: 8px;
            display: flex; align-items: center; justify-content: center;
        }

        .heatmap-high { background: var(--pk-yellow) !important; border: 3px solid var(--pk-brown) !important; box-shadow: 0 5px 12px rgba(250, 204, 21, 0.2); }
        .heatmap-mid { background: #fef08a; border: 2px solid var(--pk-brown); }
        .heatmap-low { background: white; opacity: 0.5; border: 1px solid rgba(120, 53, 15, 0.04); }

        .month-scroll {
            display: flex; gap: 6px;
            overflow-x: auto; padding-bottom: 2px;
        }
        .month-scroll::-webkit-scrollbar { height: 3px; }
        .month-scroll::-webkit-scrollbar-thumb { background: var(--pk-brown); border-radius: 10px; opacity: 0.1; }

        .filter-btn { 
            padding: 4px 1px; 
            font-size: 9px; 
            font-weight: 800;
            border: 1.5px solid rgba(120, 53, 15, 0.12); 
            background: white; 
            border-radius: 5px; 
            color: var(--pk-brown);
            text-align: center;
        }
        .filter-btn.active { background: var(--pk-brown); color: var(--pk-yellow); border-color: var(--pk-brown); }

        #matrix-tooltip { 
            position: fixed; pointer-events: none; 
            background: white; border: 2px solid var(--pk-brown); 
            padding: 8px 12px; border-radius: 10px; 
            display: none; z-index: 1000; 
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
            font-size: 11px;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        @keyframes pulse-brown {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }
        .animate-status { animation: pulse-brown 2s infinite; }
        .dragging { opacity: 0.3; transform: scale(0.95); }

        /* Ê≠∑Âè≤Ê∏ÖÂñÆ‰∫§‰∫í‰øÆÂæ© */
        .history-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 14px;
            border-bottom: 1px solid rgba(120, 53, 15, 0.08);
            font-size: 12px;
            transition: all 0.2s;
            cursor: default;
        }
        .history-item:hover { background: rgba(250, 204, 21, 0.1); }
        .btn-delete-log {
            padding: 4px 10px;
            background: #fee2e2;
            color: #ef4444;
            border-radius: 6px;
            font-weight: 900;
            font-size: 10px;
            text-transform: uppercase;
            border: 1px solid #fca5a5;
        }
        .btn-delete-log:hover { background: #ef4444; color: white; }
    </style>
</head>
<body class="flex justify-center">

    <div id="matrix-tooltip"></div>

    <div class="w-full max-w-[1780px] h-screen flex flex-col p-2.5 space-y-2.5">
        
        <!-- HEADER -->
        <header class="flex justify-between items-center shrink-0 border-b-2 border-amber-900/10 pb-1.5 px-1">
            <div class="flex items-center gap-3">
                <div class="bg-amber-900 p-1 rounded shadow-sm">
                    <i data-lucide="zap" class="text-yellow-400 w-4 h-4"></i> 
                </div>
                <h1 class="text-lg font-black italic tracking-tighter text-amber-900 uppercase">
                    PTCG ÂæóÂç°ÊåëÊà∞ <span class="text-amber-700 font-bold not-italic text-[9px] opacity-40 ml-1">v4.8 ADMIN</span>
                </h1>
                <nav id="account-tabs" class="flex gap-0.5 overflow-x-auto no-scrollbar ml-2"></nav>
                <div class="flex items-center gap-2 ml-1">
                    <button onclick="window.addNewAccount()" class="px-2 py-0.5 text-[9px] font-black text-amber-800 hover:text-amber-600 flex items-center gap-0.5 uppercase transition-all">
                        <i data-lucide="plus-circle" class="w-3 h-3"></i> Êñ∞Â¢û
                    </button>
                    <button onclick="window.openHistoryModal()" class="px-2 py-0.5 text-[9px] font-black text-amber-800 hover:text-amber-600 flex items-center gap-0.5 uppercase transition-all bg-amber-900/5 rounded">
                        <i data-lucide="clock" class="w-3 h-3"></i> Ê≠∑Âè≤
                    </button>
                </div>
            </div>
            
            <div class="flex items-center gap-4">
                <div class="flex items-center gap-2 bg-white py-0.5 px-3 rounded-full border border-amber-900/10 shadow-sm">
                    <div id="cloud-status-dot" class="w-2 h-2 rounded-full bg-slate-300 animate-status"></div>
                    <span id="cloud-status" class="text-[9px] text-amber-900 font-black uppercase">ÂêåÊ≠•‰∏≠</span>
                </div>
                <p id="live-clock" class="text-lg font-black text-amber-900 font-mono">00:00:00</p>
            </div>
        </header>

        <!-- DASHBOARD BODY -->
        <div class="grid grid-cols-12 gap-4 flex-1 min-h-0">
            
            <!-- LEFT COLUMN -->
            <div class="col-span-3 flex flex-col min-h-0 space-y-2.5">
                
                <!-- 1. ÈáèÂ≠êÂ∞ç‰ΩçÊìç‰ΩúÂè∞ -->
                <div class="bg-white border-2 border-amber-900/10 p-3.5 rounded-[1.8rem] shadow-sm shrink-0 relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-1 bg-yellow-400 rounded-t-full"></div>
                    
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-[9px] font-black text-amber-900 uppercase tracking-widest">ÈáèÂ≠êÂ∞ç‰ΩçÁ≥ªÁµ±</h3>
                        <button onclick="window.resetMapping()" class="text-[9px] text-amber-900 font-black hover:bg-amber-50 px-2 py-0.5 border border-amber-900/10 rounded-md transition-all">ÈáçÁΩÆ</button>
                    </div>

                    <div class="flex flex-col items-center space-y-3">
                        <div class="w-full flex flex-col items-center gap-1.5">
                            <span class="text-[8px] text-amber-800/30 font-black uppercase italic">1. ÂàùÂßãÂàÜÂ∏É</span>
                            <div class="flex flex-col gap-2 w-full px-1">
                                <div class="flex justify-center gap-2.5">
                                    <div id="start-0" onclick="window.selectSource(0)" class="mapping-node">1</div>
                                    <div id="start-1" onclick="window.selectSource(1)" class="mapping-node">2</div>
                                    <div id="start-2" onclick="window.selectSource(2)" class="mapping-node">3</div>
                                </div>
                                <div class="flex justify-center gap-2.5">
                                    <div id="start-3" onclick="window.selectSource(3)" class="mapping-node">4</div>
                                    <div id="start-4" onclick="window.selectSource(4)" class="mapping-node">5</div>
                                </div>
                            </div>
                        </div>

                        <div class="opacity-10 leading-none"><i data-lucide="chevron-down" class="w-3 h-3 text-amber-900"></i></div>

                        <div class="w-full flex flex-col items-center gap-1.5">
                            <div class="flex flex-col gap-2 w-full px-1">
                                <div class="flex justify-center gap-2.5">
                                    <div id="end-0" onclick="window.selectTarget(0)" class="mapping-node">1</div>
                                    <div id="end-1" onclick="window.selectTarget(1)" class="mapping-node">2</div>
                                    <div id="end-2" onclick="window.selectTarget(2)" class="mapping-node">3</div>
                                </div>
                                <div class="flex justify-center gap-2.5">
                                    <div id="end-3" onclick="window.selectTarget(3)" class="mapping-node">4</div>
                                    <div id="end-4" onclick="window.selectTarget(4)" class="mapping-node">5</div>
                                </div>
                            </div>
                            <span class="text-[8px] text-emerald-600 font-black uppercase italic mt-1">2. Êè≠ÊõâÁµêÊûú</span>
                        </div>
                    </div>

                    <button id="commit-btn" onclick="window.commitMapping()" disabled class="w-full mt-3 py-3 bg-slate-100 text-slate-300 font-black rounded-2xl text-[11px] uppercase border border-slate-200">ÈåÑÂÖ•ÂêåÊ≠•Êï∏Êìö</button>
                </div>

                <!-- 2. Êï∏ÊìöÁØ©ÈÅ∏Èù¢Êùø -->
                <div class="bg-white border-2 border-amber-900/10 p-4 rounded-[1.8rem] shadow-sm h-fit space-y-4 overflow-hidden">
                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-[10px] font-black text-amber-900 uppercase">Êúà‰ªΩ (ÊúÄÊñ∞Âú®Â∑¶)</span>
                            <button onclick="window.setMonthFilter('all')" class="text-[9px] text-amber-900 underline font-black">ALL</button>
                        </div>
                        <div id="month-selector" class="month-scroll no-scrollbar"></div>
                    </div>
                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-[10px] font-black text-amber-900 uppercase">ÊôÇÊÆµÁØ©ÈÅ∏ (HOUR)</span>
                            <button onclick="window.setHourFilter('all')" class="text-[9px] text-amber-900 underline font-black">ALL</button>
                        </div>
                        <div class="grid grid-cols-8 gap-1 w-full" id="hour-selector"></div>
                    </div>
                </div>

                <!-- 3. Êï∏ÊìöÁµ±Ë®àÂç° -->
                <div class="bg-yellow-400 border-2 border-amber-900/10 p-3 rounded-2xl flex justify-between items-center shadow-sm shrink-0">
                    <div>
                        <span class="text-[8px] font-black uppercase opacity-60">Êï∏ÊìöÁ∏ΩÊ®£Êú¨Êï∏</span>
                        <p id="db-count" class="text-2xl font-black font-mono leading-none mt-1">0</p>
                    </div>
                    <div class="bg-amber-900 text-yellow-400 text-[9px] font-black px-3 py-1 rounded-lg">SYNC_OK</div>
                </div>
            </div>

            <!-- RIGHT COLUMN -->
            <div class="col-span-9 flex flex-col min-h-0">
                <div class="bg-white border-2 border-amber-900/10 p-5 rounded-[2.8rem] shadow-xl flex-1 flex flex-col min-h-0 relative">
                    <div class="flex justify-between items-center mb-4 shrink-0">
                        <h3 class="text-sm font-black text-amber-900 uppercase tracking-widest flex items-center gap-2">
                            <i data-lucide="layout-grid"></i> Âç≥ÊôÇÊï∏ÊìöÁÜ±ÂäõÂúñ (LIVE_MATRIX)
                        </h3>
                        <div class="flex items-center gap-2">
                            <div class="bg-amber-900 text-yellow-400 px-5 py-2 rounded-full font-black text-[10px] uppercase shadow-md">
                                <span id="active-account-label">DANIEL</span>
                            </div>
                            <div class="bg-amber-50 px-5 py-2 rounded-full border border-amber-900/5 font-black text-[10px] text-amber-700/60 uppercase">
                                <span id="active-month-label">ÂÖ®ÈÉ®Êúà‰ªΩ</span>
                            </div>
                        </div>
                    </div>

                    <div class="flex-1 min-h-0">
                        <div class="matrix-container">
                            <div class="grid grid-cols-6 gap-2 shrink-0 mb-1">
                                <div class="flex items-center justify-center text-[10px] text-amber-800/30 font-black italic">Start \ End</div>
                                <div class="flex items-center justify-center text-xs font-black text-amber-900/40">R1</div>
                                <div class="flex items-center justify-center text-xs font-black text-amber-900/40">R2</div>
                                <div class="flex items-center justify-center text-xs font-black text-amber-900/40">R3</div>
                                <div class="flex items-center justify-center text-xs font-black text-amber-900/40">R4</div>
                                <div class="flex items-center justify-center text-xs font-black text-amber-900/40">R5</div>
                            </div>
                            <div id="matrix-body" class="contents"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: Êñ∞Â¢ûÂúòÈöä -->
    <div id="account-modal" class="fixed inset-0 bg-amber-900/40 backdrop-blur-xl hidden z-[3000] flex items-center justify-center p-8">
        <div class="bg-white border-4 border-amber-900 p-10 rounded-[3rem] w-full max-w-sm shadow-2xl text-center">
            <h4 class="text-xl font-black text-amber-900 uppercase mb-8 tracking-widest">Êñ∞Â¢ûÂúòÈöäËªåÈÅì</h4>
            <input type="text" id="new-account-name" placeholder="ÂúòÈöä‰ª£Ëôü..." class="w-full bg-amber-50 border-2 border-amber-900/10 p-5 rounded-2xl text-xl focus:border-yellow-400 outline-none mb-10 text-amber-900 text-center font-black uppercase">
            <div class="flex gap-4">
                <button onclick="window.closeAccountModal()" class="flex-1 py-4 text-sm font-black uppercase hover:text-red-500">ÂèñÊ∂à</button>
                <button onclick="window.confirmAddAccount()" class="flex-1 py-4 bg-yellow-400 text-amber-900 border-2 border-amber-900 rounded-2xl font-black uppercase active:scale-95 shadow-md">ÂêåÊ≠•</button>
            </div>
        </div>
    </div>

    <!-- MODAL: Ê≠∑Âè≤Á¥ÄÈåÑËàáÁÆ°ÁêÜ (Â¢ûÂä†Â±§Á¥ö) -->
    <div id="history-modal" class="fixed inset-0 bg-amber-900/60 backdrop-blur-2xl hidden z-[3000] flex items-center justify-center p-8">
        <div class="bg-white border-4 border-amber-900 p-8 rounded-[4rem] w-full max-w-lg shadow-2xl flex flex-col h-[75vh]">
            <div class="flex justify-between items-center mb-6 shrink-0">
                <h4 class="text-2xl font-black text-amber-900 uppercase tracking-widest">Êï∏ÊìöÊó•Ë™å</h4>
                <button onclick="window.closeHistoryModal()" class="w-10 h-10 flex items-center justify-center bg-amber-100 rounded-full text-amber-900 font-black">‚úï</button>
            </div>
            
            <!-- List Container -->
            <div id="history-list" class="flex-1 overflow-y-auto pr-2 no-scrollbar border-y-2 border-amber-900/5 bg-amber-50/20 rounded-xl">
                <!-- ÂÖßÂÆπÁî± JS Â°´ÂÖÖ -->
            </div>

            <!-- Global Actions -->
            <div class="mt-6 pt-4 shrink-0 text-center">
                <p class="text-[10px] text-red-500 font-black mb-4 uppercase tracking-[0.2em]">‚ö†Ô∏è Á∑äÊÄ•Êåá‰ª§ÔºöÊ∏ÖÁ©∫ÂÖ®ÂüüÊï∏Êìö ‚ö†Ô∏è</p>
                <button onclick="window.handleGlobalReset()" class="w-full py-5 bg-red-500 text-white border-b-4 border-red-800 rounded-2xl font-black uppercase text-sm hover:translate-y-0.5 active:border-b-0 transition-all shadow-lg">ÂæπÂ∫ïÊ≠∏Èõ∂Ë≥áÊñôÂ∫´ (Ëº∏ÂÖ• RESET ALL)</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, setDoc, deleteDoc, updateDoc, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const myFirebaseConfig = {
            apiKey: "AIzaSyAX496RzlcdFFkUMb0d7XukQR8Sa_M3sHs",
            authDomain: "ptcg-game.firebaseapp.com",
            projectId: "ptcg-game",
            storageBucket: "ptcg-game.firebasestorage.app",
            messagingSenderId: "43138226380",
            appId: "1:43138226380:web:8b35894b21c4c074920a69"
        };

        let history = [];
        let rawHistoryData = []; 
        let accounts = [];
        let activeAccount = 'DANIEL';
        let activeHourFilter = 'all';
        let activeMonthFilter = 'all';
        let currentMapping = new Array(5).fill(-1);
        let activeSource = -1;
        let db, auth, user;
        const firestoreId = 'ptcg-pocket-daniel';

        // --- Ê†∏ÂøÉ‰∫§‰∫í ---
        window.selectSource = (idx) => {
            activeSource = idx;
            renderMappingUI(); 
        };

        window.selectTarget = (idx) => {
            if (activeSource === -1) return;
            currentMapping.forEach((target, src) => { if (target === idx) currentMapping[src] = -1; });
            currentMapping[activeSource] = idx;
            const next = currentMapping.findIndex(m => m === -1);
            activeSource = (next !== -1) ? next : -1;
            renderMappingUI();
            updateCommitBtnState();
        };

        const renderMappingUI = () => {
            document.querySelectorAll('[id^="start-"]').forEach((el, i) => {
                const isSelected = activeSource === i;
                const isUsed = currentMapping[i] !== -1;
                el.className = `mapping-node ${isUsed ? 'used' : (isSelected ? 'selected' : '')}`;
            });
            document.querySelectorAll('[id^="end-"]').forEach((el, i) => {
                const sourceIdx = currentMapping.indexOf(i);
                el.className = "mapping-node";
                el.innerText = i + 1;
                if (sourceIdx !== -1) {
                    el.classList.add(`color-${sourceIdx}`, "selected");
                    el.innerHTML = `<span class="text-[10px] mr-1 opacity-40 italic">S</span>${sourceIdx + 1}`;
                }
            });
        };

        const updateCommitBtnState = () => {
            const btn = document.getElementById('commit-btn');
            const isFull = currentMapping.every(m => m !== -1);
            if (isFull) {
                btn.disabled = false;
                btn.className = "w-full mt-3 py-3 bg-yellow-400 text-amber-900 border-2 border-amber-900 font-black rounded-3xl text-sm transition-all cursor-pointer shadow-lg active:scale-95 uppercase tracking-widest";
                btn.innerText = "‚ö° Êï∏ÊìöÂêåÊ≠• ‚ö°";
            } else {
                btn.disabled = true;
                btn.className = "w-full mt-3 py-3 bg-slate-100 text-slate-300 font-black rounded-3xl text-sm cursor-not-allowed border border-slate-200";
                btn.innerText = "Á≠âÂæÖÂ∞ç‰Ωç";
            }
        };

        window.resetMapping = () => {
            currentMapping = new Array(5).fill(-1);
            activeSource = -1;
            renderMappingUI();
            updateCommitBtnState();
        };

        window.commitMapping = async () => {
            if (!user) return;
            const log = {
                mapping: [...currentMapping],
                t: Date.now(),
                h: new Date().getHours(),
                m: new Date().getMonth() + 1,
                y: new Date().getFullYear(),
                acc: activeAccount === 'ALL' ? 'DANIEL' : activeAccount
            };
            try {
                await addDoc(collection(db, 'artifacts', firestoreId, 'public', 'data', 'logs'), log);
                window.resetMapping();
            } catch (e) { console.error(e); }
        };

        // --- Ê≠∑Âè≤ÁÆ°ÁêÜ‰øÆÂæ© ---
        window.openHistoryModal = () => {
            document.getElementById('history-modal').classList.remove('hidden');
            renderHistoryList();
        };
        window.closeHistoryModal = () => document.getElementById('history-modal').classList.add('hidden');

        const renderHistoryList = () => {
            const container = document.getElementById('history-list');
            container.innerHTML = '';
            
            const sorted = [...rawHistoryData].sort((a,b) => b.t - a.t).slice(0, 30);
            
            if (sorted.length === 0) {
                container.innerHTML = '<div class="py-20 text-center opacity-30 italic">Êö´ÁÑ°Êï∏ÊìöÁ¥ÄÈåÑ</div>';
                return;
            }

            sorted.forEach(item => {
                const div = document.createElement('div');
                div.className = 'history-item';
                const time = new Date(item.t).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                const path = item.mapping.map(m => m + 1).join('‚Üí');
                
                div.innerHTML = `
                    <div class="flex flex-col">
                        <div class="flex items-center gap-2">
                            <span class="bg-amber-900 text-white px-2 py-0.5 rounded text-[9px] font-black uppercase">${item.acc || 'DANIEL'}</span>
                            <span class="opacity-40 font-mono text-[10px]">${time}</span>
                        </div>
                        <div class="mt-1 font-black text-amber-900 text-sm tracking-widest">${path}</div>
                    </div>
                    <button onclick="window.deleteSingleLog('${item.id}')" class="btn-delete-log">Âà™Èô§Á¥ÄÈåÑ</button>
                `;
                container.appendChild(div);
            });
        };

        window.deleteSingleLog = async (id) => {
            if (confirm("Á¢∫ÂÆöÂà™Èô§ÈÄôÁ≠ÜÈåÑÂÖ•ÈåØË™§ÁöÑÊï∏ÊìöÂóéÔºü")) {
                try {
                    await deleteDoc(doc(db, 'artifacts', firestoreId, 'public', 'data', 'logs', id));
                    // Áõ£ËÅΩÂô®ÊúÉËá™ÂãïËß∏Áôº renderHistoryList()
                } catch (e) { alert("Ê¨äÈôê‰∏çË∂≥ÊàñÁ∂≤Ë∑ØÁï∞Â∏∏„ÄÇ"); }
            }
        };

        window.handleGlobalReset = async () => {
            const code = prompt("üö® Ê≥®ÊÑèÔºöÊ≠§Êìç‰ΩúÂ∞áÊ∏ÖÁ©∫ÊâÄÊúâÊï∏ÊìöÔºÅ\nË´ãËº∏ÂÖ• RESET ALL Á¢∫Ë™çÔºö");
            if (code === "RESET ALL") {
                try {
                    const snap = await getDocs(collection(db, 'artifacts', firestoreId, 'public', 'data', 'logs'));
                    const batch = writeBatch(db);
                    snap.docs.forEach(d => batch.delete(d.ref));
                    await batch.commit();
                    alert("Êï∏ÊìöÂ∫´Â∑≤ÈáçÁΩÆ„ÄÇ");
                    window.closeHistoryModal();
                } catch (e) { alert("ÈáçÁΩÆÂ§±Êïó„ÄÇ"); }
            }
        };

        // --- ÂúòÈöäÁÆ°ÁêÜ ---
        window.addNewAccount = () => document.getElementById('account-modal').classList.remove('hidden');
        window.closeAccountModal = () => document.getElementById('account-modal').classList.add('hidden');
        window.confirmAddAccount = async () => {
            const name = document.getElementById('new-account-name').value.trim().toUpperCase();
            if (name && !accounts.find(a => a.name === name)) {
                await setDoc(doc(collection(db, 'artifacts', firestoreId, 'public', 'data', 'accounts')), { name, order: accounts.length + 1 });
                window.setAccount(name);
            }
            window.closeAccountModal();
        };

        window.deleteAccount = async (e, id, name) => {
            e.stopPropagation();
            if (name === 'DANIEL') return;
            if (confirm(`Âà™Èô§ÂúòÈöä [${name}]Ôºü`)) {
                await deleteDoc(doc(db, 'artifacts', firestoreId, 'public', 'data', 'accounts', id));
                if (activeAccount === name) window.setAccount('ALL');
            }
        };

        window.editAccountName = async (id, old) => {
            if (old === 'DANIEL') return;
            const next = prompt(`ÊîπÂêç [${old}] ÁÇ∫:`, old);
            if (next && next.trim().toUpperCase() !== old) {
                await updateDoc(doc(db, 'artifacts', firestoreId, 'public', 'data', 'accounts', id), { name: next.trim().toUpperCase() });
            }
        };

        window.setAccount = (name) => {
            activeAccount = name;
            document.getElementById('active-account-label').innerText = name;
            renderTabs(); renderMatrix();
        };

        const renderTabs = () => {
            const container = document.getElementById('account-tabs');
            container.innerHTML = '';
            const base = [{ name: 'ALL', sp: true }, { name: 'DANIEL', sp: true }];
            const sorted = accounts.sort((a,b) => (a.order || 0) - (b.order || 0));
            [...base, ...sorted].forEach(acc => {
                const btn = document.createElement('div');
                btn.className = `tab-btn ${activeAccount === acc.name ? 'active' : ''}`;
                btn.innerText = acc.name === 'ALL' ? 'ÂÖ®Âüü' : acc.name;
                btn.draggable = !acc.sp;
                if (!acc.sp) {
                    const del = document.createElement('span');
                    del.className = 'delete-x'; del.innerHTML = '√ó';
                    del.onclick = (e) => window.deleteAccount(e, acc.id, acc.name);
                    btn.appendChild(del);
                    btn.ondblclick = () => window.editAccountName(acc.id, acc.name);
                    btn.ondragstart = (e) => { e.dataTransfer.setData('text/id', acc.id); };
                    btn.ondrop = async (e) => {
                        const dragId = e.dataTransfer.getData('text/id');
                        if (dragId === acc.id) return;
                        const dAcc = accounts.find(a => a.id === dragId);
                        const tAcc = accounts.find(a => a.id === acc.id);
                        if (dAcc && tAcc) {
                            await updateDoc(doc(db, 'artifacts', firestoreId, 'public', 'data', 'accounts', dragId), { order: tAcc.order || 0 });
                            await updateDoc(doc(db, 'artifacts', firestoreId, 'public', 'data', 'accounts', acc.id), { order: dAcc.order || 0 });
                        }
                    };
                    btn.ondragover = (e) => e.preventDefault();
                }
                btn.onclick = () => window.setAccount(acc.name);
                container.appendChild(btn);
            });
        };

        const renderMatrix = () => {
            const body = document.getElementById('matrix-body');
            body.innerHTML = '';
            let filtered = history;
            if (activeAccount !== 'ALL') filtered = filtered.filter(l => l.acc === activeAccount);
            if (activeHourFilter !== 'all') filtered = filtered.filter(l => l.h === activeHourFilter);
            if (activeMonthFilter !== 'all') {
                const [y, m] = activeMonthFilter.split('-').map(Number);
                filtered = filtered.filter(l => l.y === y && l.m === m);
            }
            let matrix = Array.from({length: 5}, () => new Array(5).fill(0));
            let startTotals = new Array(5).fill(0);
            filtered.forEach(log => {
                if(log.mapping) log.mapping.forEach((target, src) => { if(target !== -1 && target < 5) { matrix[src][target]++; startTotals[src]++; } });
            });
            for (let s = 0; s < 5; s++) {
                const rowWrap = document.createElement('div');
                rowWrap.className = 'matrix-grid-row';
                const head = document.createElement('div');
                head.className = "flex items-center justify-center font-black text-amber-900/20 text-xs uppercase";
                head.innerText = `S${s+1}`; rowWrap.appendChild(head);
                for (let r = 0; r < 5; r++) {
                    const count = matrix[s][r];
                    const percent = startTotals[s] > 0 ? (count / startTotals[s]) : 0;
                    const cell = document.createElement('div');
                    let bg = "heatmap-low";
                    if (percent >= 0.4) bg = "heatmap-high";
                    else if (percent >= 0.2) bg = "heatmap-mid";
                    cell.className = `matrix-cell ${count > 0 ? bg : ''} transition-all hover:scale-[1.03] cursor-help shadow-sm`;
                    cell.innerHTML = count > 0 ? `${Math.round(percent * 100)}%` : '-';
                    cell.onmouseenter = (e) => {
                        const tip = document.getElementById('matrix-tooltip');
                        tip.style.display = 'block'; tip.style.left = (e.clientX + 10) + 'px'; tip.style.top = (e.clientY + 10) + 'px';
                        tip.innerHTML = `<p class="font-black text-amber-900 text-xs">S${s+1}‚ÜíR${r+1}</p><p class="text-amber-800 text-[10px]">Ê®£Êú¨: ${count}</p>`;
                    };
                    cell.onmouseleave = () => document.getElementById('matrix-tooltip').style.display = 'none';
                    rowWrap.appendChild(cell);
                }
                body.appendChild(rowWrap);
            }
        };

        window.setHourFilter = (h) => { activeHourFilter = h; renderHourSelector(); renderMatrix(); };
        window.setMonthFilter = (m) => { activeMonthFilter = m; renderMonthSelector(); renderMatrix(); };

        const renderHourSelector = () => {
            const container = document.getElementById('hour-selector');
            container.innerHTML = '';
            for (let i = 0; i < 24; i++) {
                const btn = document.createElement('button');
                btn.className = `filter-btn ${activeHourFilter === i ? 'active' : ''}`;
                btn.innerText = i; btn.onclick = () => window.setHourFilter(i);
                container.appendChild(btn);
            }
        };

        const renderMonthSelector = () => {
            const container = document.getElementById('month-selector');
            container.innerHTML = '';
            const months = [...new Set(history.map(l => `${l.y}-${String(l.m).padStart(2,'0')}`))].sort().reverse();
            months.forEach(m => {
                const btn = document.createElement('button');
                btn.className = `filter-btn px-4 py-1.5 ${activeMonthFilter === m ? 'active' : ''}`;
                btn.innerText = m; btn.onclick = () => window.setMonthFilter(m);
                container.appendChild(btn);
            });
        };

        const startApp = async () => {
            lucide.createIcons(); renderHourSelector();
            setInterval(() => { document.getElementById('live-clock').innerText = new Date().toTimeString().split(' ')[0]; }, 1000);
            try {
                const app = initializeApp(myFirebaseConfig); db = getFirestore(app); auth = getAuth(app);
                await signInAnonymously(auth);
                onAuthStateChanged(auth, (u) => {
                    user = u;
                    if(u) {
                        document.getElementById('cloud-status').innerText = "Êï∏ÊìöÂ∞±Á∑í";
                        document.getElementById('cloud-status-dot').classList.replace('bg-slate-300', 'bg-emerald-500');
                        onSnapshot(collection(db, 'artifacts', firestoreId, 'public', 'data', 'logs'), (snap) => {
                            rawHistoryData = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                            history = rawHistoryData.map(d => ({ ...d }));
                            renderMonthSelector(); renderMatrix();
                            if(!document.getElementById('history-modal').classList.contains('hidden')) renderHistoryList();
                            document.getElementById('db-count').innerText = history.length;
                        });
                        onSnapshot(collection(db, 'artifacts', firestoreId, 'public', 'data', 'accounts'), (snap) => {
                            accounts = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                            renderTabs();
                        });
                    }
                });
            } catch (e) { console.error("Config Error"); }
        };
        startApp();
    </script>
</body>
</html>
